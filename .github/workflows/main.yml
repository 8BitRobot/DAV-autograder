name: Lab 1

on:
  push:
    branches:
      - '*'
      - '!main'

jobs:
  test-miniALU:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with: 
        ref: ${{ github.ref }}

    - run: |
        git fetch origin team-0
        git clone --branch team-0 --single-branch https://github.com/8BitRobot/DAV-autograder.git /tmp/team-0-branch

    - uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9

    - name: Install dependencies
      run: |
        pip3 install -r requirements.txt
        sudo apt install -y --no-install-recommends iverilog

    - name: Load Test Configuration from Branch
      id: load-config
      run: |
        CONFIG_FILE="./.github/workflows/test-config.yml"

        if [ ! -f $CONFIG_FILE ]; then
          echo "$CONFIG_FILE not found in branch."
          exit 1
        fi

        KEY_PATH="/tmp/team-0-branch/"
        TEST_FILES=$(sed "s/^/$KEY_PATH/" "$CONFIG_FILE" | tr '\n' ' ')

        echo "TEST_FILEPATH=/tmp/team-0-branch/$TEST_FILES" >> $GITHUB_ENV

    - name: Verify with cocotb & icarus
      run: |
        echo "running tests in: $TEST_FILEPATH"
        pytest --pyargs "$TEST_FILEPATH"
